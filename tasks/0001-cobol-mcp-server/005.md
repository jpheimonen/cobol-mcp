# 005: Structural validation and polish

## Context

Steps 001–004 created all the project deliverables: the COBOL source, wrapper script, test script, and README. Since there is no COBOL compiler available in this environment, we cannot compile or run the server to verify it works at runtime. Instead, this final step performs every verification that is possible without a compiler — structural validation of all files, content checks against the requirements, and any polish or fixes discovered during validation.

This is the "measure twice" step. Walk through every success criterion in the requirements, every acceptance criterion in the testing plan, and every structural check — fixing anything that's missing or wrong. The goal is to ship a project that is as correct as possible given the constraint that we can't actually run it.

## Related Code

- `src/mcp-server.cob` — The main COBOL source to validate structurally
- `run.sh` — The wrapper script to validate for existence, executability, and content
- `test/test-mcp-server.sh` — The test script to validate for existence, executability, and content
- `README.md` — The README to validate for completeness
- `tasks/0001-cobol-mcp-server/requirements.md` — The success criteria checklist to verify against
- `tasks/0001-cobol-mcp-server/testing.md` — The structural validation tests and COBOL source content checks to run

## Reuse Opportunities

None — this step is purely validation and fixes. No new abstractions needed.

## Deliverables

### Run all structural validation checks from testing.md

Walk through every check in the "Structural Validation Tests" and "COBOL Source Content Validation" sections of testing.md. For each check, verify it passes. If it doesn't, fix the relevant file.

**File existence checks:**
- The main COBOL source file exists under `src/`
- The wrapper script `run.sh` exists at the project root
- The test script exists at `test/test-mcp-server.sh`
- `README.md` exists at the project root

**COBOL source structural checks:**
- Contains all four COBOL divisions: IDENTIFICATION DIVISION, ENVIRONMENT DIVISION, DATA DIVISION, PROCEDURE DIVISION
- Uses GnuCOBOL free-format (has `>>SOURCE FORMAT FREE` or equivalent directive, and does not use fixed-format column layout)
- Contains ACCEPT statements (reading from stdin)
- Contains DISPLAY statements (writing to stdout)

**COBOL source protocol content checks:**
- Contains the string `initialize` in the context of method handling
- Contains handling for `notifications/initialized`
- Contains handling for `ping`
- Contains handling for `tools/list`
- Contains handling for `tools/call`
- Contains the protocol version string `2025-11-25`
- Contains the server name `cobol-mcp-server`
- Contains tool names `add`, `format_currency`, and `validate_date`
- Contains error code -32601 (Method not found)
- Contains error code -32700 (Parse error)
- Contains a PICTURE clause for currency formatting (the signature COBOL feature)

**Script checks:**
- `run.sh` is executable and references `cobc`
- `run.sh` references the COBOL source file path
- `test/test-mcp-server.sh` is executable
- The test script contains test cases (sends JSON-RPC messages and checks responses)

**README checks:**
- Mentions all three tools by name
- Contains MCP client configuration guidance (mentions `claude_desktop_config.json` or similar)
- Contains GnuCOBOL installation guidance
- Is non-trivially sized (not just a title)

### Fix any issues found

If any of the above checks fail, go back and fix the relevant file. This may involve:
- Adding missing content to the COBOL source
- Fixing the wrapper script
- Expanding the README
- Correcting the test script

### Final polish pass

Review the COBOL source for:
- Consistent naming conventions for paragraphs and variables
- Comments explaining non-obvious sections (especially the JSON parsing logic)
- Reasonable working storage sizes (buffers large enough for MCP messages)

Review the README for:
- Tone consistency (fun but informative)
- Accuracy of instructions
- No broken references

### Update the .gitignore

Ensure `.gitignore` includes entries for compiled COBOL binaries and any build artifacts that the wrapper script might produce, so they don't get committed.

## Acceptance Criteria

- [x] All file existence checks pass: COBOL source, run.sh, test script, README all exist at their expected paths
- [x] The COBOL source contains all four divisions (IDENTIFICATION, ENVIRONMENT, DATA, PROCEDURE)
- [x] The COBOL source uses free-format (contains the free-format directive)
- [x] The COBOL source contains ACCEPT and DISPLAY statements for stdin/stdout I/O
- [x] The COBOL source contains handling strings for all five MCP methods: initialize, notifications/initialized, ping, tools/list, tools/call
- [x] The COBOL source contains the protocol version `2025-11-25`
- [x] The COBOL source contains the server name `cobol-mcp-server`
- [x] The COBOL source contains all three tool names: add, format_currency, validate_date
- [x] The COBOL source contains error codes -32601 and -32700
- [x] The COBOL source contains at least one PICTURE clause used for currency formatting
- [x] `run.sh` is executable and references both `cobc` and the COBOL source file
- [x] `test/test-mcp-server.sh` is executable
- [x] The README mentions all three tools, includes client configuration guidance, and includes GnuCOBOL installation instructions
- [x] `.gitignore` covers compiled COBOL binaries and build artifacts
- [x] No obvious structural issues remain — the project is as complete and correct as possible without a compiler
