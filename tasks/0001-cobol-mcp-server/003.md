# 003: Tool implementations

## Context

Steps 001 and 002 built the program skeleton, JSON handling, lifecycle handshake, and request routing with stubs for `tools/list` and `tools/call`. This step replaces those stubs with real implementations — the three tools that are the whole point of this project.

Each tool was chosen because it showcases something COBOL is genuinely good at: arithmetic with COMPUTE, currency formatting with PICTURE clauses, and date validation with structured date handling. The tool descriptions should lean into this — this is a joke project, and the tool metadata is part of the comedy.

This step also completes the `tools/list` response so it returns proper tool definitions with names, descriptions, and input schemas, and adds error handling for unknown tool names and invalid arguments.

## Related Code

- `src/mcp-server.cob` — The main program with routing stubs from step 002. This step replaces the `tools/list` and `tools/call` stub paragraphs/sections with full implementations. It also adds working storage variables for tool-specific data (numeric fields, date components, currency formatting fields).

## Reuse Opportunities

- The JSON response generation paragraph from step 001 should be reused to build all tool result responses. Each tool handler prepares the result content string and then calls the shared response builder.
- The JSON field extraction paragraph from step 001 should be reused to pull tool arguments out of the `params.arguments` portion of the incoming message (e.g., extracting numeric values for `add`, the date string for `validate_date`, the amount for `format_currency`).
- The error response generation from step 002 provides the pattern for returning `isError: true` tool results.

## Deliverables

### Modifications to `src/mcp-server.cob`

**New working storage variables for tools:**
- Numeric fields for the `add` tool: two input numbers and a result, sized to handle reasonable decimal values
- A currency formatting field using COBOL's PICTURE clause with dollar sign, comma separators, decimal point, and zero suppression — this is the field that demonstrates COBOL's native superiority at currency formatting
- Date component fields for the `validate_date` tool: year, month, day as separate numeric variables, plus a validity flag and an error reason string

**Tools/list handler (replace stub):**
- Respond to `tools/list` with a JSON-RPC success response containing a `tools` array with exactly three tool objects
- Each tool object must include:
  - `name`: the tool's identifier string
  - `description`: a human-readable description of what the tool does (should be witty — lean into the COBOL humor)
  - `inputSchema`: a JSON Schema object describing the tool's expected arguments
- Tool 1 — `add`: takes two required numeric arguments (`a` and `b`)
- Tool 2 — `format_currency`: takes one required numeric argument (`amount`)
- Tool 3 — `validate_date`: takes one required string argument (`date`) in YYYYMMDD format
- The entire tools/list response is essentially a large static JSON blob with only the request `id` being dynamic, so it can be built as a mostly-hardcoded string template

**Tools/call dispatcher (replace stub):**
- Extract the tool name from `params.name` in the incoming message
- Match the tool name against the three known tools and dispatch to the appropriate handler paragraph
- If the tool name does not match any known tool, return a tool result with `isError` set to true and a text content message explaining the tool was not found (this is a tool execution error, not a JSON-RPC protocol error)

**Add tool handler:**
- Extract the `a` and `b` argument values from the incoming message's `params.arguments`
- Validate that both values are numeric; if not, return a tool result with `isError` true and a message explaining the input must be numeric
- Add the two numbers together
- Return a tool result with a text content item containing the sum as a string
- The text should include some context (not just the bare number) — e.g., something that indicates COBOL computed this

**Format currency tool handler:**
- Extract the `amount` argument value from the incoming message's `params.arguments`
- Validate that the value is numeric; if not, return a tool result with `isError` true
- Move the numeric value into the PICTURE-formatted currency field, letting COBOL's native formatting apply dollar signs, comma separators, decimal point, and zero suppression
- Return a tool result with a text content item containing the formatted currency string
- The formatted output should look like standard US currency (e.g., for 1234567.89 the output would be something like `$1,234,567.89`)

**Validate date tool handler:**
- Extract the `date` argument value from the incoming message's `params.arguments`
- Validate that the string is exactly 8 characters and all numeric; if not, return a tool result with `isError` true explaining the expected YYYYMMDD format
- Break the date into year, month, and day components
- Validate the month is between 01 and 12
- Validate the day is valid for the given month, taking into account:
  - Months with 30 days vs 31 days
  - February: 28 days normally, 29 in a leap year
  - Leap year rules: divisible by 4, except centuries, except centuries divisible by 400
- If the date is valid, return a tool result with a text content item confirming validity
- If the date is invalid, return a tool result with `isError` true (or a non-error result with an explanatory message — either approach is acceptable) explaining what specifically is wrong (invalid month, invalid day, not a leap year, etc.)

## Acceptance Criteria

- [ ] The `tools/list` response contains exactly three tool objects in the `tools` array
- [ ] Each tool in the list has `name`, `description`, and `inputSchema` fields
- [ ] The tool names are `add`, `format_currency`, and `validate_date`
- [ ] Each tool's `inputSchema` describes its expected arguments with types and required fields
- [ ] Calling `add` with two numeric values returns a result containing their sum
- [ ] Calling `add` with non-numeric values returns a result with `isError` true
- [ ] Calling `format_currency` with a numeric value returns a dollar-formatted string with dollar sign, commas, and decimal point
- [ ] Calling `format_currency` with a large number (e.g., millions) produces correct comma separation
- [ ] Calling `format_currency` with zero returns a sensible formatted result (not blank or garbled)
- [ ] Calling `validate_date` with a valid date returns a result confirming validity
- [ ] Calling `validate_date` with an invalid month returns a result indicating the month is invalid
- [ ] Calling `validate_date` with an invalid day for the month returns a result indicating the day is invalid
- [ ] Calling `validate_date` with February 29 on a leap year (e.g., 20240229) returns valid
- [ ] Calling `validate_date` with February 29 on a non-leap year (e.g., 20250229) returns invalid
- [ ] Calling `validate_date` with a non-8-character or non-numeric string returns an error result
- [ ] Calling `tools/call` with an unknown tool name returns a result with `isError` true (not a JSON-RPC protocol error)
- [ ] All tool results use the text content type with a `type` of `text` and a `text` field
- [ ] The COBOL source uses a PICTURE clause for currency formatting (this is the whole joke — verify the PIC clause exists in the source)
